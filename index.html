<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>13F Signal Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a25;
      --border: #2a2a3a;
      --text-primary: #f0f0f5;
      --text-secondary: #8888a0;
      --text-muted: #555566;
      --accent-red: #ff4757;
      --accent-red-dim: #ff475733;
      --accent-green: #2ed573;
      --accent-green-dim: #2ed57333;
      --accent-yellow: #ffa502;
      --accent-blue: #3742fa;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 40px 24px; }

    header { text-align: center; margin-bottom: 60px; position: relative; }
    header::before {
      content: '';
      position: absolute;
      top: -100px; left: 50%; transform: translateX(-50%);
      width: 600px; height: 400px;
      background: radial-gradient(ellipse, var(--accent-blue) 0%, transparent 70%);
      opacity: 0.08; pointer-events: none;
    }

    .logo { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--text-muted); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 16px; }
    h1 { font-size: 48px; font-weight: 700; letter-spacing: -1px; margin-bottom: 16px; background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .subtitle { color: var(--text-secondary); font-size: 18px; font-weight: 300; }
    .casual-quote { text-align: center; font-size: 13px; color: var(--text-muted); margin-top: 16px; font-style: italic; }

    .meta-bar { display: flex; justify-content: center; gap: 32px; margin-top: 32px; padding: 16px 24px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap; }
    .meta-item { display: flex; align-items: center; gap: 8px; }
    .meta-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .meta-value { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--text-primary); }

    .source-selector { display: flex; justify-content: center; gap: 12px; margin-bottom: 32px; }
    .source-btn { font-family: 'JetBrains Mono', monospace; font-size: 13px; padding: 12px 24px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; }
    .source-btn:hover { border-color: var(--text-muted); color: var(--text-primary); }
    .source-btn.active { border-color: var(--accent-blue); background: rgba(55, 66, 250, 0.1); color: var(--text-primary); }
    .source-btn .flag { margin-right: 8px; }
    .source-btn.loading { opacity: 0.6; pointer-events: none; position: relative; }
    .source-btn.loading::after { content: ''; position: absolute; top: 50%; right: 12px; transform: translateY(-50%); width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 0.8s linear infinite; }

    .section { margin-bottom: 48px; }
    .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .section-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .section-icon.danger { background: var(--accent-red-dim); }
    .section-icon.success { background: var(--accent-green-dim); }
    .section-title { font-size: 24px; font-weight: 600; }
    .section-count { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--text-muted); margin-left: auto; }

    .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }

    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; transition: all 0.2s ease; }
    .card:hover { border-color: var(--text-muted); transform: translateY(-2px); }
    .card.danger { border-left: 3px solid var(--accent-red); }
    .card.warning { border-left: 3px solid var(--accent-yellow); }
    .card.success { border-left: 3px solid var(--accent-green); }

    .card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
    .card-symbol { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
    .card-badge { font-family: 'JetBrains Mono', monospace; font-size: 11px; padding: 4px 10px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .card-badge.high { background: var(--accent-red-dim); color: var(--accent-red); }
    .card-badge.medium { background: rgba(255, 165, 2, 0.2); color: var(--accent-yellow); }
    .card-badge.new { background: var(--accent-green-dim); color: var(--accent-green); }
    .card-detail { color: var(--text-secondary); font-size: 14px; margin-bottom: 16px; }
    .card-rule { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 4px; margin-bottom: 12px; display: inline-block; }

    .changes-list { display: flex; flex-direction: column; gap: 8px; }
    .change-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; }
    .change-period { font-family: 'JetBrains Mono', monospace; color: var(--text-muted); font-size: 11px; }
    .change-percent { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
    .change-percent.positive { color: var(--accent-green); }
    .change-percent.negative { color: var(--accent-red); }

    .stats-row { display: flex; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    .stat { flex: 1; }
    .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--text-primary); }

    .action-summary { margin-bottom: 48px; padding: 32px; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%); border: 2px solid var(--border); border-radius: 20px; position: relative; overflow: hidden; }
    .action-summary::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--accent-red), var(--accent-yellow), var(--accent-green)); }
    .action-title { font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 24px; display: flex; align-items: center; gap: 8px; }
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 768px) { .action-grid { grid-template-columns: 1fr; } }
    .action-box { padding: 24px; border-radius: 12px; }
    .action-box.dont-buy { background: var(--accent-red-dim); border: 1px solid var(--accent-red); }
    .action-box.watch { background: var(--accent-green-dim); border: 1px solid var(--accent-green); }
    .action-box-title { font-family: 'JetBrains Mono', monospace; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .action-box.dont-buy .action-box-title { color: var(--accent-red); }
    .action-box.watch .action-box-title { color: var(--accent-green); }
    .action-list { list-style: none; }
    .action-list li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 4px; }
    .action-list li:last-child { border-bottom: none; }
    .action-symbol { font-weight: 600; font-size: 15px; }
    .action-reason { font-size: 12px; color: var(--text-muted); }
    .action-rule { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    .delay-notice { font-size: 11px; color: var(--accent-yellow); margin-top: 16px; padding: 8px 12px; background: rgba(255, 165, 2, 0.1); border-radius: 6px; text-align: center; }

    .disclaimer { margin-top: 60px; padding: 24px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; text-align: center; }
    .disclaimer-title { font-size: 12px; color: var(--accent-yellow); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 12px; }
    .disclaimer-text { color: var(--text-muted); font-size: 14px; max-width: 600px; margin: 0 auto; }

    .empty-state { text-align: center; padding: 48px; color: var(--text-muted); }
    .loading-inline { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 20px; color: var(--text-muted); }
    .loading-spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      h1 { font-size: 32px; }
      .meta-bar { flex-direction: column; gap: 16px; }
      .cards-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const casualQuotes = [
      "í™”ì„± ê°ˆë„ë‹ˆê¹Œ ğŸš€",
      "ë²„í• í˜•ì´ ë­ ìƒ€ë‚˜ ë´ì•¼ì§€ ğŸ‘€",
      "ë–¡ìƒ ê¸°ì› ğŸ™"
    ];

    function formatPercent(percent) {
      return `${percent > 0 ? '+' : ''}${percent.toFixed(1)}%`;
    }

    function formatValue(valueK) {
      const m = valueK / 1000;
      return m >= 1000 ? `$${(m/1000).toFixed(1)}B` : `$${m.toFixed(1)}M`;
    }

    function getRuleTag(item) {
      if (item.reason === 'CONSECUTIVE_DECREASE') return 'Consecutive Sell';
      if (item.reason === 'LIQUIDATED') return 'Full Exit';
      if (item.signal === 'NEW_POSITION') return 'New Position';
      if (item.signal === 'CONSECUTIVE_INCREASE') return 'Consecutive Buy';
      return '';
    }

    function LoadingSpinner() {
      return (
        <div className="loading-inline">
          <div className="loading-spinner"></div>
          <span>ë¡œë”© ì¤‘...</span>
        </div>
      );
    }

    function MetaBar({ metadata }) {
      if (!metadata) return <LoadingSpinner />;
      
      return (
        <div className="meta-bar">
          <div className="meta-item">
            <span className="meta-label">ì†ŒìŠ¤</span>
            <span className="meta-value">{metadata.flag || ''} {metadata.source}</span>
          </div>
          <div className="meta-item">
            <span className="meta-label">ìµœì‹  ê³µì‹œ</span>
            <span className="meta-value">{metadata.latestFiling}</span>
          </div>
          <div className="meta-item">
            <span className="meta-label">ë¶„ì„ ë¶„ê¸°</span>
            <span className="meta-value">{metadata.analyzedQuarters?.length || 0}ê°œ</span>
          </div>
          <div className="meta-item">
            <span className="meta-label">ë³´ìœ  ì¢…ëª©</span>
            <span className="meta-value">{metadata.totalPositions}ê°œ</span>
          </div>
        </div>
      );
    }

    function ExclusionCard({ item }) {
      const severityClass = item.severity === 'HIGH' ? 'danger' : 'warning';
      
      return (
        <div className={`card ${severityClass}`}>
          <div className="card-header">
            <span className="card-symbol">{item.symbol}</span>
            <span className={`card-badge ${item.severity === 'HIGH' ? 'high' : 'medium'}`}>
              {item.severity}
            </span>
          </div>
          <span className="card-rule">RULE: {getRuleTag(item)}</span>
          <p className="card-detail">{item.detail}</p>
          {item.changes && item.changes.length > 0 && (
            <div className="changes-list">
              {item.changes.map((c, idx) => (
                <div key={idx} className="change-item">
                  <span className="change-period">
                    {c.period.split(' â†’ ').map(d => d.slice(5)).join(' â†’ ')}
                  </span>
                  <span className={`change-percent ${c.percent >= 0 ? 'positive' : 'negative'}`}>
                    {formatPercent(c.percent)}
                  </span>
                </div>
              ))}
            </div>
          )}
          {item.currentShares > 0 && (
            <div className="stats-row">
              <div className="stat">
                <div className="stat-label">í˜„ì¬ ë³´ìœ </div>
                <div className="stat-value">{item.currentShares.toLocaleString()} ì£¼</div>
              </div>
              <div className="stat">
                <div className="stat-label">ê°€ì¹˜</div>
                <div className="stat-value">{formatValue(item.currentValueK)}</div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function WatchlistCard({ item }) {
      return (
        <div className="card success">
          <div className="card-header">
            <span className="card-symbol">{item.symbol}</span>
            <span className="card-badge new">
              {item.signal === 'NEW_POSITION' ? 'NEW' : 'UP'}
            </span>
          </div>
          <span className="card-rule">RULE: {getRuleTag(item)}</span>
          <p className="card-detail">{item.detail}</p>
          {item.changes && item.changes.length > 0 && (
            <div className="changes-list">
              {item.changes.slice(0, 3).map((c, idx) => (
                <div key={idx} className="change-item">
                  <span className="change-period">
                    {c.period.split(' â†’ ').map(d => d.slice(5)).join(' â†’ ')}
                  </span>
                  <span className={`change-percent ${c.percent >= 0 ? 'positive' : 'negative'}`}>
                    {formatPercent(c.percent)}
                  </span>
                </div>
              ))}
            </div>
          )}
          <div className="stats-row">
            <div className="stat">
              <div className="stat-label">í˜„ì¬ ë³´ìœ </div>
              <div className="stat-value">{item.currentShares.toLocaleString()} ì£¼</div>
            </div>
            <div className="stat">
              <div className="stat-label">ê°€ì¹˜</div>
              <div className="stat-value">{formatValue(item.currentValueK)}</div>
            </div>
          </div>
        </div>
      );
    }

    function ActionSummary({ data }) {
      if (!data) return <LoadingSpinner />;

      const seen = new Set();
      const uniqueExc = data.exclusionList.filter(i => !seen.has(i.symbol) && seen.add(i.symbol));
      seen.clear();
      const uniqueWatch = data.watchlist.filter(i => !seen.has(i.symbol) && seen.add(i.symbol));

      return (
        <div className="action-summary">
          <div className="action-title">
            ğŸ“Š Delayed Signals ({data.metadata.latestFiling} ê³µì‹œ ê¸°ì¤€)
          </div>
          <div className="action-grid">
            <div className="action-box dont-buy">
              <div className="action-box-title">âš ï¸ Risk Signals</div>
              <ul className="action-list">
                {uniqueExc.slice(0, 4).length > 0 ? (
                  uniqueExc.slice(0, 4).map((item, idx) => (
                    <li key={idx}>
                      <div>
                        <span className="action-symbol">{item.symbol}</span>
                        <span className="action-rule">{getRuleTag(item)}</span>
                      </div>
                      <span className="action-reason">{item.detail}</span>
                    </li>
                  ))
                ) : (
                  <li><span className="action-symbol">ì—†ìŒ</span></li>
                )}
              </ul>
            </div>
            <div className="action-box watch">
              <div className="action-box-title">ğŸ“ˆ Positive Signals</div>
              <ul className="action-list">
                {uniqueWatch.slice(0, 4).length > 0 ? (
                  uniqueWatch.slice(0, 4).map((item, idx) => (
                    <li key={idx}>
                      <div>
                        <span className="action-symbol">{item.symbol}</span>
                        <span className="action-rule">{getRuleTag(item)}</span>
                      </div>
                      <span className="action-reason">{item.detail}</span>
                    </li>
                  ))
                ) : (
                  <li><span className="action-symbol">ì—†ìŒ</span></li>
                )}
              </ul>
            </div>
          </div>
          <div className="delay-notice">
            â± 13F ê³µì‹œëŠ” ë¶„ê¸° ì¢…ë£Œ í›„ ìµœëŒ€ 45ì¼ ì§€ì—°ë©ë‹ˆë‹¤. ì´ ë°ì´í„°ëŠ” ê³¼ê±° ì‹œì  ê¸°ì¤€ì…ë‹ˆë‹¤.
          </div>
        </div>
      );
    }

    function App() {
      const [currentSource, setCurrentSource] = useState('berkshire');
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [quote, setQuote] = useState(casualQuotes[0]);

      const showRandomQuote = useCallback(() => {
        const randomQuote = casualQuotes[Math.floor(Math.random() * casualQuotes.length)];
        setQuote(randomQuote);
      }, []);

      const loadData = useCallback(async (source) => {
        try {
          setLoading(true);
          setError(null);
          const response = await fetch(`/api/signals/${source}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const jsonData = await response.json();
          setData(jsonData);
        } catch (e) {
          setError(e.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        } finally {
          setLoading(false);
        }
      }, []);

      useEffect(() => {
        loadData(currentSource);
      }, [currentSource, loadData]);

      useEffect(() => {
        showRandomQuote();
        const interval = setInterval(showRandomQuote, 10000);
        return () => clearInterval(interval);
      }, [showRandomQuote]);

      const handleSourceChange = (source) => {
        if (loading || currentSource === source) return;
        setCurrentSource(source);
      };

      const seen = new Set();
      const uniqueExc = data?.exclusionList?.filter(i => !seen.has(i.symbol) && seen.add(i.symbol)) || [];
      seen.clear();
      const uniqueWatch = data?.watchlist?.filter(i => !seen.has(i.symbol) && seen.add(i.symbol)) || [];

      return (
        <div className="container">
          <header>
            <div className="logo">ğŸš€ To The Moon</div>
            <h1>Signal Dashboard</h1>
            <p className="subtitle">í˜•ë‹˜ë“¤ ë­ ìƒ€ë‚˜ í›”ì³ë³´ê¸°</p>
            <MetaBar metadata={data?.metadata} />
            <p className="casual-quote">"{quote}"</p>
          </header>

          <div className="source-selector">
            <button
              className={`source-btn ${currentSource === 'berkshire' ? 'active' : ''} ${loading && currentSource === 'berkshire' ? 'loading' : ''}`}
              onClick={() => handleSourceChange('berkshire')}
              disabled={loading}
            >
              <span className="flag">ğŸ‡ºğŸ‡¸</span>Berkshire Hathaway
            </button>
            <button
              className={`source-btn ${currentSource === 'nps' ? 'active' : ''} ${loading && currentSource === 'nps' ? 'loading' : ''}`}
              onClick={() => handleSourceChange('nps')}
              disabled={loading}
            >
              <span className="flag">ğŸ‡°ğŸ‡·</span>êµ­ë¯¼ì—°ê¸ˆ
            </button>
          </div>

          <ActionSummary data={data} />

          <section className="section">
            <div className="section-header">
              <div className="section-icon danger">ğŸš«</div>
              <h2 className="section-title">Risk Signals</h2>
              <span className="section-count">
                {loading ? '-' : `${uniqueExc.length}ê°œ ì¢…ëª©`}
              </span>
            </div>
            <div className="cards-grid">
              {loading ? (
                <LoadingSpinner />
              ) : error ? (
                <div className="empty-state">ì˜¤ë¥˜ ë°œìƒ</div>
              ) : uniqueExc.length > 0 ? (
                uniqueExc.map((item, idx) => <ExclusionCard key={idx} item={item} />)
              ) : (
                <div className="empty-state">ë¦¬ìŠ¤í¬ ì‹ í˜¸ ì—†ìŒ ğŸ‘</div>
              )}
            </div>
          </section>

          <section className="section">
            <div className="section-header">
              <div className="section-icon success">ğŸ“ˆ</div>
              <h2 className="section-title">Positive Signals</h2>
              <span className="section-count">
                {loading ? '-' : `${uniqueWatch.length}ê°œ ì¢…ëª©`}
              </span>
            </div>
            <div className="cards-grid">
              {loading ? (
                <LoadingSpinner />
              ) : error ? (
                <div className="empty-state">ì˜¤ë¥˜ ë°œìƒ</div>
              ) : uniqueWatch.length > 0 ? (
                uniqueWatch.map((item, idx) => <WatchlistCard key={idx} item={item} />)
              ) : (
                <div className="empty-state">ê¸ì • ì‹ í˜¸ ì—†ìŒ</div>
              )}
            </div>
          </section>

          <div className="disclaimer">
            <div className="disclaimer-title">âš ï¸ ë³¸ í˜ì´ì§€ëŠ” ì°¸ê³ ìš© í˜ì´ì§€ì…ë‹ˆë‹¤.</div>
            <div className="disclaimer-title">13F ê³µì‹œ ë°ì´í„°ëŠ” ìµœëŒ€ 45ì¼ê¹Œì§€ ì§€ì—°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
